name: Build Lambda Layer (Pillow + Matplotlib + Reportlab)

on:
  workflow_dispatch:

jobs:
  build-layer:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run build inside Amazon Linux 2023
        uses: addnab/docker-run-action@v3
        with:
          image: public.ecr.aws/amazonlinux/amazonlinux:2023
          options: --platform=linux/amd64
          run: |
            echo "Installing system dependencies..."
            dnf install -y python3.9 python3.9-pip \
                           libtiff libjpeg libpng freetype ghostscript

            echo "Creating layer directory structure..."
            mkdir -p /opt/python
            mkdir -p /opt/lib

            echo "Upgrading pip..."
            pip3.9 install --upgrade pip

            echo "Installing Python packages into /opt/python..."
            pip3.9 install Pillow matplotlib reportlab -t /opt/python

            echo "Copying native shared libraries..."
            cp /usr/lib64/libtiff.so.6* /opt/lib/ || true
            cp /usr/lib64/libjpeg.so.* /opt/lib/ || true
            cp /usr/lib64/libpng16.so.* /opt/lib/ || true
            cp /usr/lib64/libfreetype.so.* /opt/lib/ || true
            cp /usr/lib64/libz.so.* /opt/lib/ || true

            echo "Creating ZIP file..."
            cd /opt
            zip -r9 /layer.zip .

      - name: Upload layer.zip artifact
        uses: actions/upload-artifact@v4
        with:
          name: layer
          path: layer.zip
          retention-days: 7
